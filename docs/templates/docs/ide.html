{% extends 'base.html' %} 
{% block content %}
  <h1>Hello World!</h1>

  <form id="form">
    <input type="submit" />
    <button type="button" id="stop-btn">Stop</button>
    <button type="button" id="clear-terminal-btn">Clear Terminal</button>
    <br />
    <textarea name="message" cols="50" rows="20" id="text-area"></textarea>
  </form>
  

  <script type="text/javascript">
    let url = "ws://" + window.location.host.toString() + "/ws/socket-server/";

    const chatSocket = new WebSocket(url);

    chatSocket.onmessage = function (e) {
      let data = JSON.parse(e.data);

      if (data.type === "chat_message") {
        let messages = document.getElementById("messages");
        document.getElementById("text-area").value = data.message;
      } else if (data.type === "input_response") {
        let resultForm = document.querySelector("#result-form");
        if (resultForm) {
          resultForm.value = data.message;
        } else {
          const form = document.querySelector("#form");
          const resultForm = document.createElement("textarea");
          resultForm.cols = 50;
          resultForm.rows = 2;
          resultForm.id = "result-form";
          resultForm.value = "";
          resultForm.value = data.message;
          form.appendChild(resultForm);
        }
      }
    };

    let input = document.querySelector('textarea[name="message"]');
    input.addEventListener("input", (e) => {
      let message = e.target.value;
      chatSocket.send(JSON.stringify({ message: message }));
    });

    let hasTerminal = false;

    const form = document.querySelector("#form");
    form.addEventListener("submit", (e) => {
      e.preventDefault();
    
      let terminal = document.getElementById("result-form");
    
      if (hasTerminal) {
        if (terminal) {
          terminal.value = "";
        }
      }
    
      const content = input.value;
    
      chatSocket.send(JSON.stringify({ content: content }));
      hasTerminal = true;
    });
    

    let stopBtn = document.getElementById("stop-btn");
    let clearTerminalBtn = document.getElementById("clear-terminal-btn");

    stopBtn.addEventListener("click", (e) => {
      chatSocket.send(JSON.stringify({ stop: true }));
    });

    clearTerminalBtn.addEventListener("click", (e) => {
      let terminal = document.getElementById("result-form");
      if (terminal) {
        terminal.value = "";
      }
    });


    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "j") {
        const terminal = document.getElementById("result-form");
        if (terminal) {
          terminal.remove();
          hasTerminal = false;
        }
      }
    });
  </script>
{% endblock %}
