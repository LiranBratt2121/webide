{% extends 'base.html' %} 
{% block head %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/show-hint.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/material-darker.min.css">

<!-- CodeMirror JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/show-hint.min.js"></script>


<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/show-hint.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/fold/foldgutter.min.css">

<!-- CodeMirror JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/fold/comment-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/fold/indent-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/fold/xml-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/fold/markdown-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/fold/markdown-fold.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.63.2/addon/hint/show-hint.min.js"></script>
{% endblock head %}

{% block content %}
<h1 class="text-center mb-5">Webide Python Interpreter</h1>

<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <form id="form">
            <div class="form-group mb-3">
              <textarea name="message" cols="50" rows="20" id="text-area" class="form-control"></textarea>
            </div>
            <div class="btn-group mb-3" role="group">
              <button type="submit" id="run-btn" class="btn btn-primary btn-lg mr-2">Run</button>
              <button type="button" id="stop-btn" class="btn btn-danger mr-2">Stop</button>
              <button type="button" id="clear-terminal-btn" class="btn btn-secondary mr-2">Clear Terminal</button>
              <button type="button" id="share-link-btn" class="btn btn-info">Share Invite Link</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function snippet(cm, pos, snippet) {
    const cursor = cm.getCursor();
    const line = cm.getLine(cursor.line);
    const start = snippet.start || 0;
    const end = snippet.end || 0;
    const text = snippet.text || "";
    const replaceText = text.substring(start, text.length - end);
    
    // Insert snippet text into textarea
    const textarea = document.getElementById("text-area");
    const currentText = textarea.value;
    const newText = currentText.slice(0, textarea.selectionStart) + replaceText + currentText.slice(textarea.selectionEnd);
    textarea.value = newText;
    
    // Set cursor position
    textarea.selectionStart = textarea.selectionEnd = textarea.selectionStart + replaceText.length;
  }
  
    function showHint(cm) {
    CodeMirror.commands.autocomplete(cm, null, {hintOptions: {hint: CodeMirror.hint.python}});
  }
  
  const editor = CodeMirror.fromTextArea(document.getElementById("text-area"), {
    mode: "python",
    lineNumbers: true,
    theme: "material-darker",
    extraKeys: {
      "Ctrl-Space": "autocomplete",
      "Tab": function(cm) {
        if (cm.somethingSelected()) {
          return CodeMirror.Pass;
        }
        const cursor = cm.getCursor();
        const line = cm.getLine(cursor.line);
        const start = cursor.ch;
        let curWord = "";
        while (start && /\w/.test(line.charAt(start - 1))) {
          --start;
        }
        curWord = line.slice(start, cursor.ch);
        const token = cm.getTokenAt(cursor);
        const stringStart = token.string.toLowerCase().lastIndexOf(curWord.toLowerCase());
        const stringEnd = stringStart + curWord.length;
        const suggestions = [];
        for (let i = 0; i < snippets.length; i++) {
          if (snippets[i].text.startsWith(curWord)) {
            suggestions.push(snippets[i]);
          }
        }
        if (suggestions.length > 0) {
          cm.showHint({
            completeSingle: false,
            alignWithWord: true,
            hint: function(cm, options) {
              const list = suggestions.map((s) => ({text: s.text, displayText: s.displayText}));
              return {
                list: list,
                from: CodeMirror.Pos(cursor.line, start),
                to: CodeMirror.Pos(cursor.line, stringEnd)
              };
            },
            complete: function(cm, data, options) {
              snippet(cm, data.from, data.list[data.selected]);
            }
          });
        }
      }
    }
  });
  </script>

  
  {{ project.slug|json_script:"json-projectname" }}

  <script type="text/javascript">
    const roomName = JSON.parse(document.getElementById('json-projectname').textContent); 

    let url = "ws://" + window.location.host.toString() + "/ws/" + roomName + "/"

    const chatSocket = new WebSocket(url);

    chatSocket.onmessage = function (e) {
      let data = JSON.parse(e.data);

      if (data.type === "chat_message") {
        let messages = document.getElementById("messages");
        document.getElementById("text-area").value = data.message;
      } else if (data.type === "input_response_message") {
        let resultForm = document.querySelector("#result-form");
        if (resultForm) {
          resultForm.value = data.message;
        } else {
          const form = document.querySelector("#form");
          const resultForm = document.createElement("textarea");
          resultForm.cols = 50;
          resultForm.rows = 2;
          resultForm.id = "result-form";
          resultForm.value = "";
          resultForm.value = data.message;
          form.appendChild(resultForm);
        }
      }
    };

  const shareLinkBtn = document.getElementById("share-link-btn");

  shareLinkBtn.addEventListener("click", () => {
  const inviteLink = `${window.location.href}`;
  navigator.clipboard.writeText(inviteLink)
    .then(() => {
      alert(`Invite link copied to clipboard: ${inviteLink}`);
    })
    .catch((error) => {
      console.error(`Failed to copy invite link: ${error}`);
    });
});
    let input = document.querySelector('textarea[name="message"]');
    input.addEventListener("input", (e) => {
      let message = e.target.value;
      chatSocket.send(JSON.stringify({ message: message }));
    });

    let hasTerminal = false;

    const form = document.querySelector("#form");
    form.addEventListener("submit", (e) => {
      e.preventDefault();
    
      let terminal = document.getElementById("result-form");
    
      if (hasTerminal) {
        if (terminal) {
          terminal.value = "";
        }
      }
    
      const content = input.value;
    
      chatSocket.send(JSON.stringify({ content: content }));
      hasTerminal = true;
    });
    

    let stopBtn = document.getElementById("stop-btn");
    let clearTerminalBtn = document.getElementById("clear-terminal-btn");

    stopBtn.addEventListener("click", (e) => {
      chatSocket.send(JSON.stringify({ stop: true }));
    });

    clearTerminalBtn.addEventListener("click", (e) => {
      let terminal = document.getElementById("result-form");
      if (terminal) {
        terminal.value = "";
      }
    });


    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "j") {
        const terminal = document.getElementById("result-form");
        if (terminal) {
          terminal.remove();
          hasTerminal = false;
        }
      }
    });
  </script>
{% endblock %}
